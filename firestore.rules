rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Rules for the /users collection.
     * @path /databases/{database}/documents/users/{userId}
     * @allow (create) User with matching UID can create their own document.
     * @allow (get, update, delete) User with matching UID can get, update, and delete their own document.
     * @deny (create) User cannot create a document with a different UID.
     * @deny (get, update, delete) User cannot access another user's document.
     * @principle Enforces document ownership for user profiles, ensuring users can only manage their own data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /social_posts collection.
     * @path /databases/{database}/documents/social_posts/{postId}
     * @allow (get, list) Anyone can read social posts.
     * @allow (create) User can create a social post if the authorId matches their UID.
     * @allow (update, delete) Only the author can update or delete their social post.
     * @deny (create) User cannot create a social post with a mismatched authorId.
     * @deny (update, delete) User cannot modify or delete another user's social post.
     * @principle Allows public read access for social posts while enforcing ownership for writes.
     */
    match /social_posts/{postId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(authorId) {
            return request.auth.uid == authorId;
        }

        function isExistingOwner(authorId) {
            return isOwner(authorId) && resource.data.authorId == request.auth.uid;
        }

        allow get, list: if true;
        allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
        allow update: if isSignedIn() && request.resource.data.authorId == request.auth.uid && request.auth.uid == resource.data.authorId;
        allow delete: if isSignedIn() && resource.data.authorId == request.auth.uid && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Rules for the /withdrawal_requests collection.
     * @path /databases/{database}/documents/withdrawal_requests/{requestId}
     * @allow (get) Only authenticated users can view withdrawal requests
     * @allow (create) Only authenticated users can create a withdrawal request with their userId
     * @deny (list) Listing withdrawal requests is not allowed.
     * @allow (update,delete) No one can update or delete withdrawal requests
     * @principle Enforces that a user can create withdrawal requests, with a userId matching their authenticated id
     */
    match /withdrawal_requests/{requestId} {
        function isSignedIn() {
            return request.auth != null;
        }

        function isOwner(userId) {
            return request.auth.uid == userId;
        }

        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
        allow update, delete: if false;
    }

     /**
      * @description Rules for the /forums collection.
      * @path /databases/{database}/documents/forums/{postId}
      * @allow (get, list) Anyone can read forum posts.
      * @allow (create) Only authenticated users can create forum posts.
      * @deny (update, delete) No one can update or delete forum posts.
      * @principle Allows public read access for social posts while restricting write access.
      */
     match /forums/{postId} {
         function isSignedIn() {
             return request.auth != null;
         }

         allow get, list: if true;
         allow create: if isSignedIn();
         allow update, delete: if false;
     }

    /**
     * @description Rules for the /presale_purchases collection.
     * @path /databases/{database}/documents/presale_purchases/{purchaseId}
     * @allow (get) Only authenticated users can view presale purchases
     * @allow (create) Only authenticated users can create a presale purchases
     * @deny (list) Listing presale purchases is not allowed.
     * @allow (update,delete) No one can update or delete presale purchases
     */
    match /presale_purchases/{purchaseId} {
        function isSignedIn() {
            return request.auth != null;
        }

        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isSignedIn();
        allow update, delete: if false;
    }
  }
}