/**
 * @fileoverview Firestore Security Rules for PGC Platform
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control (RBAC) system,
 * combined with user-ownership for specific collections. The system is designed
 * to be highly scalable for a large user base and to prevent unauthorized
 * data access or modification.  Data validation is relaxed in this prototyping phase.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, secured by ownership (`userId` must match `request.auth.uid`).
 * - /social_posts/{postId}: Public read, owner-only write access for user-generated content.
 * - /withdrawal_requests/{requestId}: Public read, but creates are limited to the user. Updates and deletes are denied.
 * - /forums/{postId}: Public read access.
 * - /presale_purchases/{purchaseId}: Public read access.
 *
 * Key Security Decisions:
 * - User listing is not explicitly denied (for prototyping), but should be carefully considered for production.
 * - `get` operations are generally allowed to return "Not Found" without leaking existence information.
 * - Strict ownership is enforced on user profiles.
 * - The rules do not enforce the data schema, to allow prototyping.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages user profile data.
     * @path /users/{userId}
     * @allow (create) User with matching UID can create their own profile.
     * @allow (get, list) Any authenticated user can read user profiles.
     * @allow (update,delete) User with matching UID can update their own profile.
     * @deny (create) User tries to create a profile with a mismatched UID.
     * @principle Enforces user-ownership for profile data.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Manages social media posts.
     * @path /social_posts/{postId}
     * @allow (get, list) Any user can read any post.
     * @allow (create) Any authenticated user can create a post with their author ID.
     * @allow (update,delete) Only the author can modify or delete their own posts.
     * @deny (create) User tries to create a post with a mismatched author ID.
     * @deny (update,delete) User tries to modify or delete someone else's post.
     * @principle Enforces owner-only writes for posts, public read access.
     */
    match /social_posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner() {
        return request.auth.uid == resource.data.authorId;
      }

      allow get, list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && isOwner();
    }

    /**
     * @description Manages withdrawal requests.
     * @path /withdrawal_requests/{requestId}
     * @allow (get, list) Any user can read any request.
     * @allow (create) Any authenticated user can create a request with their user ID.
     * @deny (update,delete) No updates or deletes allowed.
     * @principle Public read access, owner-only create, immutable after creation.
     */
    match /withdrawal_requests/{requestId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages forum posts.
     * @path /forums/{postId}
     * @allow (get, list) Any user can read any forum post.
     * @deny (create, update,delete) No writes allowed.
     * @principle Public read access, no writes allowed.
     */
    match /forums/{postId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Manages presale purchase records.
     * @path /presale_purchases/{purchaseId}
     * @allow (get, list) Any user can read any purchase.
     * @deny (create, update,delete) No writes allowed.
     * @principle Public read access, no writes allowed.
     */
    match /presale_purchases/{purchaseId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}