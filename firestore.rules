/**
 * @fileoverview Firestore Security Rules for the PGC Platform.
 *
 * Core Philosophy:
 * This ruleset implements a role-based access control (RBAC) model,
 * with the user's role stored directly in their `/users/{userId}` document.
 * This approach centralizes access control logic and avoids complex queries.
 * The rules enforce strict user-ownership for user-specific data and allow
 * public read access to certain collections like 'social_posts' while
 * restricting write access to authorized users.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data. Document ID MUST match the Firebase Auth UID.
 * - /social_posts/{postId}: Stores social media posts.
 * - /withdrawal_requests/{requestId}: Stores PGC withdrawal requests.
 * - /forums/{postId}: Stores governance forum posts.
 * - /presale_purchases/{purchaseId}: Logs PGC presale purchase requests.
 *
 * Key Security Decisions:
 * - Users can only read and write their own user document.
 * - Listing of the `/users` collection is denied to prevent unauthorized access to user data.
 * - Public read access is granted to `/social_posts` and `/forums`, but writes are restricted based on ownership.
 * - All write operations are validated to ensure data integrity and prevent unauthorized modifications.
 * - Users can make withdrawal requests, but the actual processing is likely handled server-side.
 *
 * Denormalization for Authorization:
 * - User roles are stored directly in the `/users/{userId}` document to simplify authorization checks.
 * - Social posts store the author's ID to enable owner-based write restrictions.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the user profile data stored under /users/{userId}.
     * @path /users/{userId}
     * @allow (create) - If the authenticated user's UID matches the userId.
     * @allow (get, update, delete) - If the authenticated user's UID matches the userId and the document exists.
     * @deny (list) - Always.
     * @deny (create, update, delete) - If authenticated user's UID does not match the userId.
     * @principle Enforces document ownership for reads and writes, self-creation for user documents.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures the social media posts stored under /social_posts/{postId}.
     * @path /social_posts/{postId}
     * @allow (get, list) - Anyone can read all posts.
     * @allow (create) - Only if the authorId matches the authenticated user's UID.
     * @allow (update, delete) - Only if the authorId matches the authenticated user's UID and the document exists.
     * @deny (create, update, delete) - If the authorId does not match the authenticated user's UID.
     * @principle Allows public read access but restricts writes to the owner.
     */
    match /social_posts/{postId} {
      function isOwner(authorId) {
        return request.auth != null && request.auth.uid == authorId;
      }
      function isExistingOwner(authorId) {
        return isOwner(authorId) && resource != null;
      }
      allow get, list: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

     /**
      * @description Secures the withdrawal requests stored under /withdrawal_requests/{requestId}.
      * @path /withdrawal_requests/{requestId}
      * @allow (create) - Only if the userId matches the authenticated user's UID.
      * @allow (get) - Only if the userId matches the authenticated user's UID.
      * @deny (list) - Always deny listing of requests.
      * @deny (update, delete) - Always deny modification and deletion of requests.
      * @principle Restricts access to withdrawal requests based on ownership, prevents unauthorized modification.
      */
    match /withdrawal_requests/{requestId} {
      function isOwner(userId) {
          return request.auth != null && request.auth.uid == userId;
      }

      allow get: if isOwner(resource.data.userId);
      allow list: if false;
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Secures the forum posts stored under /forums/{postId}.
     * @path /forums/{postId}
     * @allow (get, list) - Anyone can read forum posts.
     * @allow (create) - Only if the authorId matches the authenticated user's UID.
     * @allow (update, delete) - Only if the authorId matches the authenticated user's UID and the document exists.
     * @deny (create, update, delete) - If the authorId does not match the authenticated user's UID.
     * @principle Allows public read access but restricts writes to the owner.
     */
    match /forums/{postId} {
      function isOwner(authorId) {
        return request.auth != null && request.auth.uid == authorId;
      }
      function isExistingOwner(authorId) {
        return isOwner(authorId) && resource != null;
      }
      allow get, list: if true;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update: if isExistingOwner(resource.data.authorId);
      allow delete: if isExistingOwner(resource.data.authorId);
    }

    /**
     * @description Secures the presale purchases stored under /presale_purchases/{purchaseId}.
     * @path /presale_purchases/{purchaseId}
     * @allow create: if false; // TODO: Determine the correct authorization for presale purchases (likely admin only).
     * @allow get: if false; // TODO: Determine the correct authorization for presale purchases (likely admin only).
     * @allow list: if false; // TODO: Determine the correct authorization for presale purchases (likely admin only).
     * @allow update: if false; // TODO: Determine the correct authorization for presale purchases (likely admin only).
     * @allow delete: if false; // TODO: Determine the correct authorization for presale purchases (likely admin only).
     * @principle Requires proper authorization for managing presale purchase data.
     */
    match /presale_purchases/{purchaseId} {
      allow create: if false;
      allow get: if false;
      allow list: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}