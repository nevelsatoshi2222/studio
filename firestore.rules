
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- USER COLLECTION RULES ---
    match /users/{userId} {
      // A user can read their own document
      allow read: if request.auth != null && request.auth.uid == userId;

      // A user can CREATE their own document during signup
      // This is the key rule to allow the client-side registration to work
      allow create: if request.auth != null && request.auth.uid == userId;

      // A user can update their own document, but with restrictions
      allow update: if request.auth != null && request.auth.uid == userId
        // A user cannot change their own UID or their referrer after creation
        && request.resource.data.uid == resource.data.uid
        && request.resource.data.referredBy == resource.data.referredBy
        
        // Prevent changing the walletPublicKey once it is set
        && (resource.data.walletPublicKey == null || request.resource.data.walletPublicKey == resource.data.walletPublicKey)
        
        // Disallow client-side modification of pgcBalance and verification status
        && request.resource.data.pgcBalance == resource.data.pgcBalance
        && request.resource.data.isVerified == resource.data.isVerified;

      // No one can delete a user document
      allow delete: if false;
      
      // Allow ONLY Super Admins to list all users
      allow list: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }
    
    // --- TRANSACTION COLLECTION RULES ---
    // Transactions are managed by the Cloud Function (admin), so client writes are forbidden
    match /transactions/{transactionId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;
      allow list: if false;
    }
    
    // --- WITHDRAWAL REQUESTS (Managed by Admin/CF) ---
    match /withdrawalRequests/{requestId} {
      // Allow a user to create a request if they are authenticated
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.amount > 0
        && request.resource.data.walletAddress != null
        // Ensure the user's balance is sufficient
        && request.resource.data.amount <= get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pgcBalance;

      // Allow users to see their own requests, but not modify them
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow update, delete: if false; // Only admin process can update status
      allow list: if false;
    }
    
    // --- PRESALE PURCHASE RULES (Managed by Admin/CF) ---
    match /presales/{purchaseId} {
      // Client-side can only read their own purchase history
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Client-side can ONLY CREATE the initial PENDING_VERIFICATION record
      allow create: if request.auth != null 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.status == 'PENDING_VERIFICATION';
        
      // Only the admin process can update status to COMPLETED
      allow update, delete: if false; 
      allow list: if false;
    }

     // --- FORUM & SOCIAL POSTS ---
    match /forums/{postId} {
      allow get, list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }
     match /social_posts/{postId} {
      allow get, list: if request.auth != null;
      allow create: if request.auth != null && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null && resource.data.authorId == request.auth.uid;
    }
  }
}
