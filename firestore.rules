rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profiles. Users can only read/write their own profile.
     * @path /users/{userId}
     * @allow (create) - If the user's auth UID matches the {userId} and they are creating their own document.
     * @allow (get, list) - if isSuperAdmin() or isUserManagerAdmin() or isOwner(userId)
     * @allow (update, delete) - if isSuperAdmin() or isUserManagerAdmin() or isExistingOwner(userId)
     * @deny (create) - If the user's auth UID does not match the {userId}.
     * @deny (update, delete) - If the user is not the owner and not an admin.
     * @principle Enforces document ownership and restricts access to user's own data or via `User Management Admin` or `Super Admin` roles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }
      
      function isSuperAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'Super Admin';
      }

      function isUserManagerAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'User Management Admin';
      }

      allow get, list: if isSuperAdmin() || isUserManagerAdmin() || isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isSuperAdmin() || isUserManagerAdmin() || isExistingOwner(userId);
      allow delete: if isSuperAdmin() || isUserManagerAdmin() || isExistingOwner(userId);
    }

    /**
     * @description Controls access to social media posts. Anyone can read, but only owners can write.
     * @path /social_posts/{postId}
     * @allow (get, list) - Any user can read social posts.
     * @allow (create) - Only authenticated users can create social posts, and must set authorId to their UID.
     * @allow (update, delete) - Only the author of the post can update or delete it.
     * @deny (create) - If the incoming authorId does not match the user's UID.
     * @deny (update, delete) - If the user is not the author of the post.
     * @principle Public read access with owner-only writes.
     */
    match /social_posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(authorId) {
        return isSignedIn() && request.auth.uid == authorId;
      }

      function isExistingOwner(authorId) {
        return isOwner(authorId) && resource.data != null;
      }
        
      allow get, list: if true;
      allow create: if isSignedIn() && request.resource.data.authorId == request.auth.uid;
      allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Controls access to withdrawal requests. Only admins can read/write withdrawal requests.
     * @path /withdrawal_requests/{requestId}
     * @allow (get, list) - If the user has the role of User Management Admin or Super Admin.
     * @allow (create, update, delete) - If the user has the role of User Management Admin or Super Admin.
     * @deny (get, list, create, update, delete) - If the user does not have the required admin role.
     * @principle Restricts access to sensitive financial data to authorized personnel.
     */
    match /withdrawal_requests/{requestId} {

      function isSignedIn() {
        return request.auth != null;
      }
        
      function isSuperAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'Super Admin';
      }

      function isUserManagerAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'User Management Admin';
      }

      allow get, list: if isSuperAdmin() || isUserManagerAdmin();
      allow create: if isSuperAdmin() || isUserManagerAdmin();
      allow update: if isSuperAdmin() || isUserManagerAdmin();
      allow delete: if isSuperAdmin() || isUserManagerAdmin();
    }

    /**
     * @description Controls access to forum posts. Anyone can read, but only authenticated users can create.
     * @path /forums/{postId}
     * @allow (get, list) - Any user can read forum posts.
     * @allow (create) - Only authenticated users can create forum posts.
     * @allow (update, delete) - Only the author of the post can update or delete it.
     * @deny (create) - If the user is not authenticated.
     * @deny (update, delete) - If the user is not the author of the post.
     * @principle Public read access with owner-only writes for modification.
     */
    match /forums/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(authorId) {
        return isSignedIn() && request.auth.uid == authorId;
      }

      function isExistingOwner(authorId) {
        return isOwner(authorId) && resource.data != null;
      }
        
      allow get, list: if true;
      allow create: if isSignedIn();
      allow update: if isSignedIn() && request.auth.uid == resource.data.authorId;
      allow delete: if isSignedIn() && request.auth.uid == resource.data.authorId;
    }

    /**
     * @description Controls access to presale purchases. Only admins can read/write presale purchases.
     * @path /presale_purchases/{purchaseId}
     * @allow (get, list) - If the user has the role of User Management Admin or Super Admin.
     * @allow (create, update, delete) - If the user has the role of User Management Admin or Super Admin.
     * @deny (get, list, create, update, delete) - If the user does not have the required admin role.
     */
    match /presale_purchases/{purchaseId} {
      function isSignedIn() {
        return request.auth != null;
      }
        
      function isSuperAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'Super Admin';
      }

      function isUserManagerAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/roles_admin/$(request.auth.uid)).data.role == 'User Management Admin';
      }
      allow get, list: if isSuperAdmin() || isUserManagerAdmin();
      allow create: if isSuperAdmin() || isUserManagerAdmin();
      allow update: if isSuperAdmin() || isUserManagerAdmin();
      allow delete: if isSuperAdmin() || isUserManagerAdmin();
    }

    /**
     * @description Grants get access to /roles_admin/{userId} for admin users. The document ID is the user's UID from Firebase Auth.
     * @path /roles_admin/{userId}
     * @allow (get) - if the user's auth UID matches the {userId}.
     * @deny (get) - If the user's auth UID does not match the {userId}.
     * @principle Grants access to roles_admin document for admin.
     */
    match /roles_admin/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }
        
      allow get: if isOwner(userId);
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}