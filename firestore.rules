/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for user profiles and referral data,
 *              allows public read access to social posts with owner-only writes, and restricts admin-level
 *              operations to authorized administrators.
 *
 * @data_structure
 *  - /users/{userId}: Stores user profile information, accessible only to the user themselves.
 *  - /users/{userId}/referrals/data: Stores referral data for a user, accessible only to that user.
 *  - /social_posts/{postId}: Stores social media posts, publicly readable but writable only by the post's owner.
 *  - /roles_admin/{userId}: Indicates admin privileges; if a document exists for a user, they are an admin.
 *  - /withdrawal_requests/{requestId}: Stores user withdrawal requests, writable by users, and accessible to admins.
 *
 * @key_security_decisions
 *  - User listing is disallowed to protect user privacy.
 *  - Admin privileges are determined by the existence of a document in the `roles_admin` collection.
 *  - Social posts are publicly readable, but creating, updating, and deleting posts is restricted to the owner.
 *  - Data consistency between user IDs in the path and document fields is enforced on `create` and `update` operations.
 *
 * @denormalization_for_authorization
 *  - The `SocialPost` entity requires an `ownerId` field to properly secure write access.
 *
 * @structural_segregation
 *  - Private user data (profile, referrals) is stored under the `/users/{userId}` path.
 *  - Public social posts are stored in the top-level `/social_posts` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows a user to read and write their own profile data.
     * @path /users/{userId}
     * @allow (get, create, update, delete) if the requesting user's UID matches the userId.
     * @deny (get, create, update, delete) if the requesting user's UID does not match the userId.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == request.resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows a user to read and write their own referral data.
     * @path /users/{userId}/referrals/data
     * @allow (get, create, update, delete) if the requesting user's UID matches the userId.
     * @deny (get, create, update, delete) if the requesting user's UID does not match the userId.
     * @principle Restricts access to a user's own referral data.
     */
    match /users/{userId}/referrals/data {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == request.resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Allows anyone to read social posts, but only the owner can create, update, or delete them.
     * @path /social_posts/{postId}
     * @allow (get, list) to anyone.
     * @allow (create) if the user's UID matches the userId in the post data.
     * @allow (update, delete) if the user's UID matches the userId of the existing post.
     * @deny (create, update, delete) if the user is not the owner of the post.
     * @principle Allows public read access with owner-only writes.
     */
    match /social_posts/{postId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows read access to admin role documents for admins themselves, and allows creation of admin role documents.
     * @path /roles_admin/{userId}
     * @allow (get) if the requesting user's UID matches the userId or the requesting user is an admin.
     * @allow (list) to no one.
     * @allow (create) if the requesting user's UID matches the userId.
     * @allow (update, delete) to admins only.
     * @principle Restricts admin role management to existing admins.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if false;
      allow delete: if isAdmin();
    }

     /**
      * @description Allows any signed-in user to create a withdrawal request. Only admins can read, update, or delete requests.
      * @path /withdrawal_requests/{requestId}
      * @allow (create) to any signed-in user.
      * @allow (get, list, update, delete) to admins only.
      * @principle Restricts management of withdrawal requests to admins.
      */
    match /withdrawal_requests/{requestId} {
        allow get, list: if isAdmin();
        allow create: if isSignedIn();
        allow update: if isAdmin();
        allow delete: if isAdmin();
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isAdmin() {
        return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
  }
}