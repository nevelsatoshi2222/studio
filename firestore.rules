/**
 * @fileoverview Firestore Security Rules for the application.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user profiles and referral data,
 * while allowing public read access to social posts. Admin privileges are managed via a
 * dedicated collection.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profile data, with the document ID matching the user's UID.
 * - /users/{userId}/referrals/data: Stores referral data specific to a user.
 * - /social_posts/{postId}: Stores social media posts from all users.
 * - /roles_admin/{userId}: Presence-based collection for managing administrator privileges.
 * - /withdrawal_requests/{requestId}: Stores withdrawal requests.
 *
 * Key Security Decisions:
 * - Users can only read and write their own profile data and referral information.
 * - Social posts are publicly readable, but creation, updates, and deletion are restricted.
 * - Admin privileges are determined by the presence of a document in the `roles_admin` collection.
 * - Listing of users is disallowed.
 *
 * Denormalization for Authorization:
 * The `/users/{userId}` document's ID is deliberately set to the Firebase Auth UID. This
 * allows the rules to quickly and securely verify user ownership without additional reads.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile data.
     * @path /users/{userId}
     * @allow (create) - User with UID 'user123' can create their profile at /users/user123 if the document.id matches their UID.
     * @allow (read) - User with UID 'user123' can read their profile at /users/user123.
     * @allow (update) - User with UID 'user123' can update their profile at /users/user123.
     * @allow (delete) - User with UID 'user123' can delete their profile at /users/user123.
     * @deny (create) - User with UID 'user456' cannot create a profile at /users/user123.
     * @principle Enforces document ownership for writes and reads.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      allow get: if isOwner(userId);
      allow list: if false; // Listing users is not permitted.
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to referral data for a specific user.
     * @path /users/{userId}/referrals/data
     * @allow (read) - User with UID 'user123' can read their referral data at /users/user123/referrals/data.
     * @allow (create) - User with UID 'user123' can create their referral data at /users/user123/referrals/data if the userId matches.
     * @allow (update) - User with UID 'user123' can update their referral data at /users/user123/referrals/data.
     * @allow (delete) - User with UID 'user123' can delete their referral data at /users/user123/referrals/data.
     * @deny (read) - User with UID 'user456' cannot read user123's referral data.
     * @principle Enforces strict ownership of referral data.
     */
    match /users/{userId}/referrals/{referralId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isOwner(userId) {
          return request.auth.uid == userId;
        }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

        allow get: if isOwner(userId);
        allow list: if false;
        allow create: if isSignedIn() && isOwner(userId);
        allow update: if isExistingOwner(userId);
        allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Controls access to social media posts.
     * @path /social_posts/{postId}
     * @allow (read) - Any user can read any social post.
     * @deny (create) - Only authenticated users can create social posts, and userId must match.
     * @deny (update) - Only the owner can update the social posts.
     * @deny (delete) - Only the owner can delete the social posts.
     * @principle Public read, owner-only writes.
     */
    match /social_posts/{postId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner() {
        return isSignedIn() && resource.data.userId == request.auth.uid;
      }
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isExistingOwner();
      allow delete: if isExistingOwner();
    }

    /**
     * @description Determines admin privileges based on document existence.
     * @path /roles_admin/{userId}
     * @allow (read) - Any authenticated user can check if a user is an admin.
     * @allow (create) - Only an existing admin can grant admin privileges.
     * @allow (update) - No direct updates allowed. Admin status is managed by document existence.
     * @allow (delete) - Only an existing admin can revoke admin privileges.
     * @deny (create) - Non-admins cannot grant admin privileges.
     *
     * @principle Presence-based role management.
     */
    match /roles_admin/{userId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isAdmin() {
            return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }

        allow get: if isSignedIn();
        allow list: if false;
        allow create: if isAdmin();
        allow update: if false;
        allow delete: if isAdmin();
    }

       /**
        * @description Controls access to withdrawal requests.
        * @path /withdrawal_requests/{requestId}
        * @allow (read) - Only admins can read withdrawal requests.
        * @allow (list) - Only admins can list withdrawal requests.
        * @allow (create) - Only authenticated users can create withdrawal requests.
        * @allow (update) - Only admins can update withdrawal requests.
        * @allow (delete) - No one can delete withdrawal requests.
        */
      match /withdrawal_requests/{requestId} {
        function isSignedIn() {
          return request.auth != null;
        }

        function isAdmin() {
            return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
        }

        allow get: if isAdmin();
        allow list: if isAdmin();
        allow create: if isSignedIn();
        allow update: if isAdmin();
        allow delete: if false;
      }
  }
}