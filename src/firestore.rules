rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ==================== HELPER FUNCTIONS ====================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      // Safely get the user's role from their document.
      // NOTE: For higher security, this should be read from custom claims (request.auth.token.role)
      // which can only be set by the backend. For now, we read from the user's document.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['Super Admin', 'User Management Admin', 'Franchisee Management Admin'];
    }

    function canVote(poll) {
        // A user can vote if the poll's geographical scope matches their own data.
        let userGeo = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        
        if (poll.geographyScope == "International") {
            return true;
        }
        if (poll.geographyScope == "National") {
            return userGeo.country == poll.country;
        }
        if (poll.geographyScope == "State") {
            return userGeo.country == poll.country && userGeo.state == poll.state;
        }
        if (poll.geographyScope == "District") {
            return userGeo.country == poll.country && userGeo.state == poll.state && userGeo.district == poll.district;
        }
        // ... and so on for Taluka, Village, Street
        return false;
    }

    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // A user can create their own document during registration.
      allow create: if isOwner(userId);
      
      // A user can read or update their OWN document.
      allow read, update: if isOwner(userId);

      // Admins can read any user document.
      allow get, list: if isAdmin();
      
      // Nobody can delete user documents from the client.
      allow delete: if false;
    }
    
    // ==================== FINANCIAL & SENSITIVE COLLECTIONS ====================
    // Only allow clients to read their own data.
    // Writes should ideally be handled by secure backend functions.
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow write: if isAuthenticated(); // Temporarily open for client-side logic
    }
    
    match /presales/{presaleId} {
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
       allow write: if isAuthenticated(); // Temporarily open for client-side logic
    }
    
    match /commissions/{commissionId} {
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
       allow write: if isAuthenticated(); // Temporarily open for client-side logic
    }

    // ==================== APPLICATIONS (Franchisee, etc.) ====================
    match /applications/{applicationId} {
      // A user can create their own application.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // A user can read their own application status.
      allow read: if isOwner(resource.data.userId);
      
      // Admins can manage all applications.
      allow read, write: if isAdmin();
    }

    // ==================== VOTING SYSTEM ====================
    match /polls/{pollId} {
      // Any logged-in user can read polls.
      allow read: if isAuthenticated();
      // Only admins can create or change polls.
      allow write: if isAdmin();
    }
    
    match /votes/{voteId} {
      // A user can create a vote if they are authenticated and meet geo requirements.
      allow create: if isAuthenticated() && canVote(get(/databases/$(database)/documents/polls/$(request.resource.data.pollId)).data);
      // A user can read their own vote.
      allow read: if isOwner(resource.data.userId);
    }
    
    // ==================== E-COMMERCE ====================
    match /products/{productId} {
      allow read: if true; // Publicly readable products
      allow create, update, delete: if isAdmin();
    }
    
    match /carts/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    match /orders/{orderId} {
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow read: if isOwner(resource.data.userId);
      allow update: if isAdmin(); // For order status updates
    }
    
    // ==================== GENERAL CONTENT (Social, Quizzes) ====================
    match /social_posts/{postId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isOwner(request.resource.data.authorId);
    }
    
    match /quiz_results/{resultId} {
       allow read, write: if isOwner(resource.data.userId);
    }

    // Fallback: Default to denying all access to other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}