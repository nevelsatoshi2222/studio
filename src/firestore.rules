
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      // Safely get the user's role from their custom claims in Auth, not from the document itself.
      // This is more secure as claims are managed by the backend.
      return request.auth.token.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['Super Admin', 'User Management Admin', 'Franchisee Management Admin', 'Job Management Admin', 'Social Media Management Admin', 'Quiz Management Admin'];
    }

    function canVote(poll) {
        // A user can vote if the poll's geographical scope matches their own data.
        let userGeo = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        
        if (poll.geographyScope == "International") {
            return true;
        }
        if (poll.geographyScope == "National") {
            return userGeo.country == poll.country;
        }
        if (poll.geographyScope == "State") {
            return userGeo.country == poll.country && userGeo.state == poll.state;
        }
        if (poll.geographyScope == "District") {
            return userGeo.country == poll.country && userGeo.state == poll.state && userGeo.district == poll.district;
        }
        // ... and so on for Taluka, Village, Street
        return false;
    }

    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // ANY logged-in user can read their OWN document.
      allow get: if isOwner(userId);
      
      // A user can ONLY update their OWN document.
      allow update: if isOwner(userId);

      // NOBODY can create or delete user documents directly. This is ONLY done by the onUserCreate backend function.
      allow create, delete: if false;

      // An ADMIN can get or list any user document.
      allow get, list: if isAdmin();
    }
    
    // ==================== SENSITIVE FINANCIAL COLLECTIONS ====================
    // Commissions, transactions, and presale records are critical.
    // They should ONLY be created by trusted backend Cloud Functions.
    // Users can only read their own records.
    match /transactions/{transactionId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create, update, delete: if false; // Block ALL client writes.
    }
    
    match /presales/{presaleId} {
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
       allow create, update, delete: if false; // Block ALL client writes.
    }
    
    match /commissions/{commissionId} {
       allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
       allow create, update, delete: if false; // Block ALL client writes.
    }

    // ==================== APPLICATIONS (Franchisee, etc.) ====================
    match /applications/{applicationId} {
      // A user can create their own application.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // A user can read or update their own application (e.g., view status).
      allow read, update: if isOwner(resource.data.userId);
      
      // Admins with franchisee management roles can view and update any application.
      allow read, update: if getUserRole() in ['Super Admin', 'Franchisee Management Admin'];
    }

    // ==================== VOTING SYSTEM ====================
    match /polls/{pollId} {
      // Any logged-in user can read polls to see what there is to vote on.
      allow read: if isAuthenticated();
      
      // Only admins can create or change polls.
      allow create, update, delete: if isAdmin();
    }
    
    match /votes/{voteId} {
      // A user can create a vote if they are authenticated AND they meet the geographical requirements.
      allow create: if isAuthenticated() && canVote(get(/databases/$(database)/documents/polls/$(request.resource.data.pollId)).data);
      
      // A user can read their own vote.
      allow read: if isOwner(resource.data.userId);
    }
    
    // ==================== E-COMMERCE ====================
    match /products/{productId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAdmin();
    }
    
    match /carts/{userId} {
      // A user can only access their own cart.
      allow read, write: if isOwner(userId);
    }
    
    match /orders/{orderId} {
      // A user can create their own order.
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // A user can only read their own orders.
      allow read: if isOwner(resource.data.userId);
      // Only admins can update order status (e.g., 'Shipped').
      allow update: if isAdmin();
    }
    
    // ==================== GENERAL CONTENT (Social, Quizzes) ====================
    match /social_posts/{postId} {
        allow read: if isAuthenticated();
        allow create, update, delete: if isOwner(request.resource.data.authorId);
    }
    
    match /quiz_results/{resultId} {
       allow read, write: if isOwner(resource.data.userId);
    }

    // ==================== SECURE FALLBACK ====================
    // Explicitly deny access to any collection not defined above.
    // This is the most important rule for security.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
