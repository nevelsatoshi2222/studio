
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a registered user of the platform, including their profile, role, and financial information.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user (matches Firebase Auth UID)."
        },
        "name": {
          "type": "string",
          "description": "User's full name."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The role of the user on the platform.",
          "enum": ["User", "Influencer", "Franchisee", "Job Seeker", "Admin"]
        },
        "street": { "type": "string", "description": "User's street address." },
        "village": { "type": "string", "description": "User's village or ward." },
        "block": { "type": "string", "description": "User's block or kasba." },
        "taluka": { "type": "string", "description": "User's taluka." },
        "district": { "type": "string", "description": "User's district." },
        "state": { "type": "string", "description": "User's state or province." },
        "country": { "type": "string", "description": "User's country." },
        "directIncome": {
          "type": "number",
          "description": "Income generated directly from the user's own activities or referrals."
        },
        "totalIncome": {
          "type": "number",
          "description": "Total income including earnings from the entire affiliate team tree."
        },
        "registeredAt": {
            "type": "string",
            "format": "date-time",
            "description": "The timestamp when the user registered."
        },
        "solanaWalletAddress": {
          "type": "string",
          "description": "The user's primary Solana wallet address for receiving PGC."
        },
        "withdrawalAddress": {
            "type": "string",
            "description": "The Solana wallet address specified by the user for a withdrawal."
        },
        "pgcBalance": {
            "type": "number",
            "description": "The user's in-app balance of PGC, before it is withdrawn to their wallet."
        },
        "referralCode": {
            "type": "string",
            "description": "The UID of the user who referred this user."
        }
      },
      "required": ["id", "name", "email", "role"]
    },
    "Referral": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Referral",
      "type": "object",
      "description": "Represents a user's affiliate marketing data, including their referral link and team structure.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The ID of the user who owns this referral data."
        },
        "referralLink": {
          "type": "string",
          "description": "The unique affiliate link for the user.",
          "format": "uri"
        },
        "directReferrals": {
          "type": "array",
          "description": "A list of user IDs directly referred by this user.",
          "items": { "type": "string" }
        },
        "totalTeamSize": {
            "type": "number",
            "description": "The total number of users in the affiliate tree under this user."
        }
      },
      "required": ["userId", "referralLink"]
    },
    "SocialPost": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SocialPost",
      "type": "object",
      "description": "Represents a post made by a user on the social media hub.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the post." },
        "userId": { "type": "string", "description": "The ID of the user who created the post." },
        "content": { "type": "string", "description": "The text content of the post." },
        "imageUrl": { "type": "string", "format": "uri", "description": "URL of an image attached to the post." },
        "timestamp": { "type": "string", "format": "date-time", "description": "When the post was created." },
        "likes": { "type": "number", "description": "Number of likes on the post." }
      },
      "required": ["id", "userId", "content", "timestamp"]
    },
    "Admin": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Admin",
      "type": "object",
      "description": "Represents an administrator account with elevated privileges.",
      "properties": {
        "userId": {
          "type": "string",
          "description": "The UID of the user who is an admin."
        }
      },
      "required": ["userId"]
    },
    "WithdrawalRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WithdrawalRequest",
      "type": "object",
      "description": "Represents a user's request to withdraw PGC from their in-app balance to their Solana wallet.",
      "properties": {
        "userId": { "type": "string", "description": "The ID of the user requesting the withdrawal." },
        "userName": { "type": "string", "description": "The name of the user." },
        "amount": { "type": "number", "description": "The amount of PGC requested." },
        "solanaAddress": { "type": "string", "description": "The destination Solana wallet address." },
        "requestedAt": { "type": "string", "format": "date-time", "description": "Timestamp of the request." },
        "status": { "type": "string", "enum": ["pending", "completed", "failed"], "description": "The status of the withdrawal request." }
      },
      "required": ["userId", "amount", "solanaAddress", "requestedAt", "status"]
    },
    "ForumPost": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ForumPost",
      "type": "object",
      "description": "A post in the governance forum.",
      "properties": {
        "title": { "type": "string" },
        "content": { "type": "string" },
        "authorId": { "type": "string" },
        "authorName": { "type": "string" },
        "authorAvatar": { "type": "string", "format": "uri" },
        "topic": { "type": "string" },
        "geography": { "type": "string" },
        "createdAt": { "type": "string", "format": "date-time" },
        "upvotes": { "type": "number" },
        "comments": { "type": "number" }
      },
      "required": ["title", "content", "authorId", "authorName", "topic", "geography", "createdAt"]
    }
  },
  "auth": {
    "providers": ["password", "anonymous"]
  },
  "firestore": {
    "rules": "rules_version = '2';\n\nservice cloud.firestore {\n  match /databases/{database}/documents {\n\n    // Function to check for admin role\n    function isAdmin() {\n      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));\n    }\n\n    match /users/{userId} {\n      // Admins can read/write any user document\n      allow list, read, write: if isAdmin();\n\n      // A user can read and write their own document.\n      allow read, write: if request.auth != null && request.auth.uid == userId;\n\n      // Allow authenticated users to query the users collection by referralCode\n      // This is needed for the 'My Team' page to find direct referrals.\n      allow list: if request.auth != null && request.query.where.referralCode == request.auth.uid;\n    }\n\n    // Allow users to read their own admin role document\n    match /roles_admin/{userId} {\n      allow get: if request.auth.uid == userId;\n      allow list, read, write: if isAdmin();\n    }\n\n    match /forums/{postId} {\n        // Any authenticated user can read all forum posts\n        allow read: if request.auth != null;\n        // Only authenticated users can create posts\n        allow create: if request.auth != null;\n        // Only the author or an admin can update/delete their own post\n        allow update, delete: if request.auth.uid == resource.data.authorId || isAdmin();\n    }\n    \n    match /withdrawal_requests/{requestId} {\n        // Admins can read/write all requests\n        allow read, write: if isAdmin();\n        // Users can only create requests for themselves\n        allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;\n    }\n\n    // Admins have blanket access for other collections as needed.\n    match /{document=**} {\n      allow read, write: if isAdmin();\n    }\n  }\n}",
    "indexes": [
        {
            "collectionGroup": "users",
            "queryScope": "COLLECTION",
            "fields": [
                {
                    "fieldPath": "referralCode",
                    "order": "ASCENDING"
                },
                {
                    "fieldPath": "registeredAt",
                    "order": "DESCENDING"
                }
            ]
        },
        {
            "collectionGroup": "forums",
            "queryScope": "COLLECTION",
            "fields": [
                {
                    "fieldPath": "createdAt",
                    "order": "DESCENDING"
                }
            ]
        }
    ],
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "schema": { "$ref": "#/entities/User" },
          "description": "Stores the public profile data for each user. The document ID is the user's UID from Firebase Auth."
        }
      },
      {
        "path": "/users/{userId}/referrals/data",
        "definition": {
          "schema": { "$ref": "#/entities/Referral" },
          "description": "A singleton document storing the referral data (link, team) for the parent user. This structure ensures a user can only access their own referral information."
        }
      },
      {
        "path": "/social_posts/{postId}",
        "definition": {
          "schema": { "$ref": "#/entities/SocialPost" },
          "description": "A top-level collection for all social media posts from all users."
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "schema": { "$ref": "#/entities/Admin" },
          "description": "An existence-based check for admin privileges. If a document exists with a user's UID, that user is an admin."
        }
      },
       {
        "path": "/withdrawal_requests/{requestId}",
        "definition": {
          "schema": { "$ref": "#/entities/WithdrawalRequest" },
          "description": "Stores all user withdrawal requests for admin processing."
        }
      },
       {
        "path": "/forums/{postId}",
        "definition": {
          "schema": { "$ref": "#/entities/ForumPost" },
          "description": "Stores posts for the governance forum."
        }
      }
    ],
    "reasoning": "This structure separates user profile data from their affiliate/referral data. Storing referral information in a subcollection of the user's document (/users/{userId}/referrals/data) allows for security rules that grant a user access only to their own referral tree and income data. Social posts are in a global collection for easy querying for the main feed. The 'roles_admin' collection provides a simple, secure way to manage administrator access. Withdrawal requests are in a separate top-level collection for easy admin review."
  }
}

    